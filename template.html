  <link href="http://www.iderail.es/testiss/css/ol.css" rel="stylesheet">
  <style type="text/css">
  .map {
    float: left;
    padding: 10px 10px;
    height: 475px;
    width: 475px;
  }
  .mapOSM {
    float: left;
    padding: 10px 10px;
    height:475px;
    width: 475px;
  }
  .mapVIIRS {
    float: left;
    padding: 10px 10px;
    height:300px;
    width: 475px;
  }  
  .txtOSM {
    float: left;
    padding: 5px 5px;
    height:160px;
    width: 160px;
  }
  .container {
    margin-right: 10px;
    margin-left: 10px;
    }
  </style>
 
<div class="row">
    <!-- Success and Error Messages for the user --> 
    <div class="span6 offset2" style="height:10px">
        <div id="success" class="alert alert-success" style="display:none;">
            <a class="close">×</a>
            <strong id="i18n_welldone">Well done!</strong> <span id="i18n_welldone_text">Your answer has been saved</span>
        </div>
        <div id="loading" class="alert alert-info" style="display:none;">
            <a class="close">×</a>
            <span id="i18n_loading_next_task">Loading next task...</span>
        </div>
        <div id="taskcompleted" class="alert alert-info" style="display:none;">
            <strong id="i18n_task_completed">The task has been completed! Thanks a lot!</strong> 
        </div>
        <div id="finish" class="alert alert-success" style="display:none;">
            <strong id="i18n_congratulations">Congratulations!</strong> <span id="i18n_congratulations_text">You have participated in all available tasks!</span>
            <br/>
            <div class="alert-actions">
                <a class="btn small" href="/">Go back</a>
                <a class="btn small" href="/app">or, Check other applications</a>
            </div>
        </div>
        <div id="error" class="alert alert-error" style="display:none;">
            <a class="close">×</a>
            <strong>Error!</strong> Something went wrong, please contact the site administrators
        </div>
    </div> <!-- End Success and Error Messages for the user -->
</div> <!-- End of Row -->

<div class="row skeleton" style="width:1550px"> <!-- Start Skeleton Row-->
    <div class="span12" style="width:1550px"><!-- Start of Question and Submission DIV (column) -->
        <h1 id="question"><span id="i18n_quiestion">Do you know about this City?</span></h1> <!-- The question will be loaded here -->
        <div id="step1" class="btn-group" style="text-align:center"> <!-- Start DIV for the submission buttons -->
            <div id="answer" class="btn-group" style="text-align:center"> <!-- Start DIV for the submission buttons -->
                <button class="btn btn-large btn-answer" value='save'><span id="i18n_save">Save</span></button>
                <button class="btn btn-large btn-answer" value='404'><span id="i18n_no_photo">No photo</span></button>
                <button class="btn btn-large btn-answer" value='unknown'><span id="i18n_i_dont_know">I don't know</span></button>
                
            </div><!-- End of DIV for the submission buttons -->

        </div><!-- End of DIV for the submission buttons -->

        <!-- Link to picture data provided by NASA site -->
        <div>
          <form id='imageQuality' name = 'imageQuality'>
      <span class="label label-danger" id="i18n_wait">Please, be patient with large ISS images</span><span class="label label-info">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id="i18n_imagesharp">Image Sharpness:</span> <span id="i18n_good">Good</span><input type='radio' name='sharp' value='good'>&nbsp;<span id="i18n_medium">Medium</span><input type='radio' name='sharp' value='medium'>&nbsp;<span id="i18n_poor">Poor</span><input type='radio' name='sharp' value='poor'>
      &nbsp;&nbsp;<span id="i18n_cloudy">Cloudy</span>: <span id="i18n_none">None</span><input type='radio' name='cloud' value='none'>&nbsp;<span id="i18n_few">Less than 50%</span><input type='radio' name='cloud' value='l50'>&nbsp;<span id="i18n_more">More than 50%</span><input type='radio' name='cloud' value='m56'><br></span></form><br>
      <span id="i18n_zoom">Green point indicates ISS location at picture time. Use the [+] and [-] buttons to Zoom In and Zoom Out. Keep Shift + Left mouse button pressed while moving the mouse will rotate the image.</span><br>
      <span id="i18n_doNotGuess">Please do not just guess at a location; that wastes time when verifying results. Please only place a mark if you are absolutely sure that its location is accurate and can be later geo-referenced point-by-point, else press the I-Don't-Know button.</span><br>
      <a id="hrefPicture" href='' target='_blank'>ISS picture data - Earth Science and Remote Sensing Unit, NASA-Johnson Space Center. "The Gateway to Astronaut Photography of Earth."</a></div>


        <!-- These are maps -->
        <div id="map" class="map"></div>
        <div id="mapOSM" class="mapOSM"></div>

        <!-- DataList to save  -->
        <form id='dataList' name='dataList'>
          
          <input type='button' onClick="removeOptions()"; value='Remove Selected'><br>
          <span class="label label-info" >XY</span>&nbsp;<input type='text' name='xyValues' style="width:150px">
          <span class="label label-info" >Lon, Lat</span>&nbsp;<input type='text' name='lonlatValues' style="width:150px"><br><br>
          <span class="label label-info" id="i18n_viirs">2012 Night View from NPP-VIIRS</span>
          &nbsp;&nbsp;&nbsp;&nbsp;<span class="label label-info" id="iss_latlon">ISS Lat,Lon=</span>
          <div id="mapVIIRS" class="mapVIIRS"></div>
        </form>
    </div><!-- End of DIV for the submission buttons -->

        <!-- -------------- Social buttons ------------- -->
        <div>
          <div id="Twitter-share-section" style='float: left'>
                    <a href="https://twitter.com/share" class="twitter-share-button" data-text="Check this amazing picture and help us to georreference it" data-size="large" data-hashtags="LostAtNight">Tweet</a>
                </div>
                <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
          </div> <!-- end twitter -->
                  
          <div class="g-plusone" style="float:left" data-annotation="inline" data-width="300"></div>

          <script type="text/javascript">
            window.___gcfg = {lang: 'es'};

            (function() {
              var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
              po.src = 'https://apis.google.com/js/platform.js';
              var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
            })();
          </script>
          <div style="float:left"> 
          <div id="fb-like" class="fb-like"  data-href="http://www.cowdcrafting.org/app/LostAtNight" data-layout="standard" data-action="like" data-show-faces="true" data-share="true"></div>
            <div id="fb-root"></div>
          </div>
          <script>(function(d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) return;
            js = d.createElement(s); js.id = id;
            js.src = "//connect.facebook.net/es_ES/sdk.js#xfbml=1&version=v2.0";
            fjs.parentNode.insertBefore(js, fjs);
          }(document, 'script', 'facebook-jssdk'));</script>
          </div>
          <!-- -------------- End social buttons -------------------- -->

</div><!-- End of DIV for the submission buttons -->


<div class="row skeleton" style="margin-top:15px;"> <!-- Start Skeleton Row-->
    <div class="span8 offset2"><!-- Start of Question and Submission DIV (column) -->
        <p><span id="i18n_working_task">You are working now on task:</span> <span id="task-id" class="label label-warning">#</span></p>
        <p><span id="i18n_tasks_completed">You have completed:</span> <span id="done" class="label label-info"></span> <span id="i18n_tasks_from">tasks from</span>
        <!-- Progress bar for the user -->
        <span id="total" class="label label-info"></span></p>
        <div class="progress progress-striped">
            <div id="progress" rel="tooltip" title="#" class="bar" style="width: 0%;"></div>
        </div>
        <!-- 
            This application uses Disqus to allow users to provide some feedback.
            The next section includes a button that when a user clicks on it will
            load the comments, if any, for the given task
        -->
        <div id="disqus_show_btn" style="margin-top:5px;">
            <button class="btn btn-primary btn-large btn-disqus" onclick="loadDisqus()"><i class="icon-comments"></i> Show comments</button>
            <button class="btn btn-large btn-disqus" onclick="loadDisqus()" style="display:none"><i class="icon-comments"></i> Hide comments</button>
        </div><!-- End of Disqus Button section -->
        <!-- Disqus thread for the given task -->
        <div id="disqus_thread" style="margin-top:5px;display:none"></div>
    </div><!-- End of Question and Submission DIV (column) -->
</div><!-- End of Skeleton Row -->

<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */

    /* * * DON'T EDIT BELOW THIS LINE * * */
    function loadDisqus() {
    $("#disqus_thread").toggle();
    $(".btn-disqus").toggle();
    var disqus_shortname = 'pybossa'; 
    var disqus_identifier = taskId;
    var disqus_developer = 1;

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    }

</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
 <script src="http://ol3js.org/en/master/build/ol.js" type="text/javascript"></script>
 <script src="http://maps.google.com/maps/api/js?v=3&amp;sensor=false"></script>
 <script src="http://openlayers.org/api/OpenLayers.js"></script>
 <script src="https://earthdata.nasa.gov/labs/gibs/examples/openlayers2/lib/openlayers-2.13.1/OpenLayers.js"></script>
 
<script>
function loadUserProgress() {
    pybossa.userProgress('LostAtNight').done(function(data){
        var pct = Math.round((data.done*100)/data.total);
        $("#progress").css("width", pct.toString() +"%");
        $("#progress").attr("title", pct.toString() + "% completed!");
        $("#progress").tooltip({'placement': 'left'}); 
        $("#total").text(data.total);
        $("#done").text(data.done);

    });
}

var xy;
var lonlat;
var clickImg = false;
var clickMap = false;
var urlImage = '';

pybossa.taskLoaded(function(task, deferred) {
    if ( !$.isEmptyObject(task) ) {

      task.answer = {
          'imageResult' : '',
          'XY': '',
          'LONLAT': '',
          'img_big': task.info.link_big,
          'rotationAngle' : '',
          'sharp': '',
          'cloud': ''
      }

      deferred.resolve(task);
    }
    else {
        deferred.resolve(task);
    }
    updateTwitterValues(window.location.href);
});

pybossa.presentTask(function(task, deferred) {
  if ( !$.isEmptyObject(task) ) {

    loadUserProgress();
    $("#hrefPicture").attr("href",task.info.linkData);
    $("#fb-like").attr("data-href",task.info.linkData);
        // first time I load the whole map
        if (firstTime){
          loadOSM(task.info.citylon,task.info.citylat,7);
          loadISSImage(task.info.link_big.replace('sseop/images','DatabaseImages'));
          firstTime = false;
        }
        else {
          removeAllOptions();
          //center OSM map if aprox location is known
          if (task.info.citylon != ''){
            changeMapOSM(task.info.citylon,task.info.citylat,7);
          }else{
            changeMapOSM(0,0,1);
          }
          loadNewISSImage(task.info.link_big.replace('sseop/images','DatabaseImages'));
        }
        document.getElementById("iss_latlon").innerHTML = "ISS Lat,Lon=" + eval(task.info.citylat).toFixed(5) + "," + eval(task.info.citylon).toFixed(5);
        
        $("#question").html(task.info.question);
        $('#task-id').html(task.id);
        $('.btn-answer').off('click').on('click', function(evt) {

          var answer = $(this).attr("value");

          if (typeof answer != 'undefined') {

            if (answer == 'save'){

                $("#step1").hide();

                task.answer.XY = document.dataList.xyValues.value;
                task.answer.LONLAT = document.dataList.lonlatValues.value;
                xy = '';
                lonlat = '';
                task.answer.sharp = readSharp();
                task.answer.cloud = readCloud();
                task.answer.rotationAngle = getRotationAngle();
                
                // Prueba para controlar el array de puntos y localización
                if (verifyPoints()){
                  $("#step1").show();
                  $("#success").show();
                  pybossa.saveTask(task.id, task.answer).done(function() {
                    deferred.resolve();
                  });
                  $("#success").hide();
                }else {
                  $("#step1").show();
                }

              }else if (answer == '404'){
                task.answer.imageResult = '404';
                pybossa.saveTask(task.id, task.answer).done(function() {
                  deferred.resolve();
                });  

              }else {

                task.answer.imageResult = 'unknown';
                pybossa.saveTask(task.id, task.answer).done(function() {
                  deferred.resolve();
                });
              }

            }
          });
        //$("#loading").hide();
      }
      else {
        $(".skeleton").hide();
        //$("#loading").hide();
        $("#finish").fadeIn(500);
      }
    });

function updateTwitterValues(share_url) {
    $("#Twitter-share-section").html('&nbsp;'); 
    $("#Twitter-share-section").html('<a href="https://twitter.com/share" class="twitter-share-button" data-url="'+share_url+'" data-text="Check out this amazing image!" data-size="large" data-hashtags="LostAtNight">Tweet</a>');
    //twttr.widgets.load();
}

// functions to show ISS picture and OSM Map
var firstTime = true;
var clickImg = false;
var clickMap = false;
var pixelProjection;

var iconStyle = new ol.style.Style({
  image: new ol.style.Circle({
      radius: 3,
      fill: new ol.style.Fill({
          color: [255, 0, 0, 1]
      }),
      stroke: new ol.style.Stroke({
          color: [255, 0, 0, 1],
          width: 1.5
      })
  }),
  zIndex: 1
});

var iconStyleVIIRS = new ol.style.Style({
  image: new ol.style.Circle({
      radius: 5,
      fill: new ol.style.Fill({
          color: [0, 204, 0, 1]
      })
  }),
  zIndex: 1
});

var iconFeature;
var map;
var ISSlayer;

function createISSLayer(urlImage, imgX, imgY){

     pixelProjection = new ol.proj.Projection({
      code: 'pixel',
      units: 'pixels',
      extent: [0, 0, eval(imgX), eval(imgY)] 

    });;

    ISSlayer = new ol.layer.Image({
        source: new ol.source.ImageStatic({
          attributions: [
            new ol.Attribution({
              html: '<a href="http://guaix.fis.ucm.es/DarkSkies">ISS - GUAIX UCM</a>'
            })
          ],
          url: urlImage,
          imageSize: [eval(imgX), eval(imgY)],
          projection: pixelProjection,
          imageExtent: pixelProjection.getExtent()
        })
      });
}

var dimX,dimY;

function loadISSImage(urlImage){

  $("#loading").show();
  var dim = new Array();
  var img = new Image();
  img.onload = function() {
      
      dim[0] = this.width;
      dim[1] = this.height;
      
      dimX = dim[0];
      dimY = dim[1];

      createISSLayer(urlImage, dimX, dimY); 
      
      map = new ol.Map({

        interactions: ol.interaction.defaults().extend([
          new ol.interaction.DragRotateAndZoom()
        ]),
        layers: [ISSlayer],

        target: 'map',

        view: new ol.View({
          projection: pixelProjection,
          center: ol.extent.getCenter(pixelProjection.getExtent()),
          zoom: 1
        })
      });


      map.on('click', function(evt) {
        var coordinate = evt.coordinate;
        var xy = ol.coordinate.toStringXY(ol.proj.transform(coordinate, pixelProjection, pixelProjection));

        if (clickImg == false){
          
          document.dataList.xyValues.value = xy;

          addPointLayer();
          clickImg = true;
          clickMap = false;

        }
      });
      $("#loading").hide();
  } // img.load
  img.src = urlImage;
  
} // loadISSImage

function getRotationAngle(){
  var currentRadians = map.getView().getRotation();
  return currentRadians;
}

function unloadISSImage(){
  window.map.removeLayer(ISSlayer);
}

function loadNewISSImage(urlImage){
  $("#loading").show();
  $('#map').hide();
  var dim = new Array();
  var img = new Image();
  img.onload = function() {
    
    dim[0] = this.width;
    dim[1] = this.height;
    
    dimX = dim[0];
    dimY = dim[1];
  
    map.getView().setRotation(0);
    map.getView().setZoom(1);
    map.removeLayer(ISSlayer);
    createISSLayer(urlImage, dimX, dimY); 
    map.getView().setCenter([dimX/2, dimY/2]);
    map.addLayer(ISSlayer);
    $('#map').show();

    $("#loading").hide();

  } // img.load
  img.src = urlImage;
}

function handleMapClick(evt) {

      if (clickMap == false){
        
        var lonlat = mapOSM.getLonLatFromViewPortPx(evt.xy).transform(new OpenLayers.Projection("EPSG:900913"), new OpenLayers.Projection("EPSG:4326"));
        var coord = lonlat.lon.toFixed(6) + ',' + lonlat.lat.toFixed(6);

        document.dataList.lonlatValues.value = coord; 
        
        addPointLayerOSM();
        clickMap = true;
        clickImg = false;
        mapOSM.addLayer(pointLayerOSM);  
      }
    } 


var mapOSM;
var osmlayer = new OpenLayers.Layer.OSM();
var gmaplayerSt = new OpenLayers.Layer.Google("Google Streets",{numZoomLevels: 20});
var gmaplayerSat = new OpenLayers.Layer.Google("Google Satellite",{type: google.maps.MapTypeId.SATELLITE, numZoomLevels: 22});

var fromProjection = new OpenLayers.Projection("EPSG:4326");
var toProjection   = new OpenLayers.Projection("EPSG:900913");

function loadOSM(lonOSM, latOSM, zoomOSM){
    mapOSM = new OpenLayers.Map({
        div: "mapOSM",
         projection: "EPSG:4326"
    });

// create point in OSM map with task coordinates
    var locationPointLayer = new OpenLayers.Layer.Vector('Location', {
            styleMap: new OpenLayers.StyleMap({
                pointRadius: "5", 
                fillColor: "#00cc00",
                strokeWidth: "0"
            }),
            renderers: renderer
        });
    var point = new OpenLayers.Geometry.Point(eval(lonOSM),eval(latOSM));
    point.transform(fromProjection, toProjection);
    var featureP = new OpenLayers.Feature.Vector(point);
    locationPointLayer.addFeatures([featureP]);

    mapOSM.addLayers([gmaplayerSt,gmaplayerSat,osmlayer, locationPointLayer]);
    mapOSM.addControl(new OpenLayers.Control.LayerSwitcher());

    var centerPosition = new OpenLayers.LonLat(eval(lonOSM),eval(latOSM)).transform( fromProjection, toProjection);
    mapOSM.setCenter(centerPosition, zoomOSM );

    mapOSM.events.register('click', mapOSM, handleMapClick);

    // visible circle 500 km
    var styleCircle = new OpenLayers.StyleMap({
                strokeColor: "#ff00ff",
                strokeWidth: 3,
                fillOpacity: 0,
                cursor: "pointer"
            });
    var circleLayer = new OpenLayers.Layer.Vector('Circle',{styleMap: styleCircle});
    mapOSM.addLayer(circleLayer);

    var sides = 40;
    var projection = mapOSM.getProjectionObject();
    var centerCircle = new OpenLayers.Geometry.Point(eval(lonOSM),eval(latOSM));
    centerCircle.transform(fromProjection, toProjection);
    var circle = OpenLayers.Geometry.Polygon.createGeodesicPolygon(centerCircle, 200, sides, 45, toProjection);
                       
    var circleFeature = new OpenLayers.Feature.Vector(circle);
    circleLayer.addFeatures([circleFeature]);


    //load VIIRS help map
    mapVIIRS = new ol.Map({
      target: 'mapVIIRS',
      layers: [
        viirs
      ],

      view: new ol.View({
        projection: ol.proj.get("EPSG:4326"),
                    extent: [-180, -90, 180, 90],
            center: [0,0],
            zoom: 1
      })
    });

    var icons = [];
    nadirISS = new ol.Feature({ geometry: new ol.geom.Point([eval(lonOSM),eval(latOSM)])});
    nadirISS.setStyle(iconStyleVIIRS);
    icons.push(nadirISS); 

    nadirLayer = new ol.layer.Vector({ source: new ol.source.Vector({ features: icons }) });
  
    mapVIIRS.addLayer(nadirLayer);

} // loadOSM


OpenLayers.Geometry.Polygon.createGeodesicPolygon = function(origin, radius, sides, rotation, projection){

    if (projection.getCode() !== "EPSG:4326") {
        origin.transform(projection, new OpenLayers.Projection("EPSG:4326"));
    }
    var latlon = new OpenLayers.LonLat(origin.x, origin.y);
    console.log(origin.x + ' ' +  origin.y);

    var angle;
    var new_lonlat, geom_point;
    var points = [];
    
    for (var i = 0; i < sides; i++) {
        angle = (i * 360 / sides) + rotation;
        new_lonlat = OpenLayers.Util.destinationVincenty(latlon, angle, radius);
        //new_lonlat.transform(new OpenLayers.Projection("EPSG:4326"), toProjection);
        geom_point = new OpenLayers.Geometry.Point(new_lonlat.lon, new_lonlat.lat);
        console.log(geom_point);
        points.push(new_lonlat);
    }
    var ring = new OpenLayers.Geometry.LinearRing(points);
    return new OpenLayers.Geometry.Polygon([ring]);
};




function changeMapOSM(lonOSM, latOSM, zoomOSM){

  // change OSM
  var centerPosition = new OpenLayers.LonLat(eval(lonOSM),eval(latOSM)).transform( fromProjection, toProjection);
  mapOSM.setCenter(centerPosition, zoomOSM );

// update point with lat and lon values
  var locationPointLayer = mapOSM.getLayersByName('Location')[0];
  locationPointLayer.removeAllFeatures();
  var point = new OpenLayers.Geometry.Point(eval(lonOSM),eval(latOSM));
  point.transform(fromProjection, toProjection);
  var featureP = new OpenLayers.Feature.Vector(point);
  locationPointLayer.addFeatures([featureP]);

  // change VIIRS
  mapVIIRS.getView().setZoom(1);
  mapVIIRS.getView().setCenter([0,0]);
  mapVIIRS.removeLayer(nadirLayer);
  var icons = [];
  nadirISS = new ol.Feature({ geometry: new ol.geom.Point([eval(lonOSM),eval(latOSM)])});
  nadirISS.setStyle(iconStyleVIIRS);
  icons.push(nadirISS); 

  nadirLayer = new ol.layer.Vector({ source: new ol.source.Vector({ features: icons }) });

  mapVIIRS.addLayer(nadirLayer);

}

function addPointLayer(){

  window.map.removeLayer(pointLayer);

  var pos = [];
  var icons = [];
    
  if(typeof dataList.xyValues.value != 'undefined'){
    
    pos = dataList.xyValues.value.split(',');

    iconFeature = new ol.Feature({ geometry: new ol.geom.Point([eval(pos[0]), eval(pos[1])])});
    iconFeature.setStyle(iconStyle);
    icons.push(iconFeature);

  }

  pointLayer = new ol.layer.Vector({ 
    source: new ol.source.Vector({ features: icons }) 
  })

  map.addLayer(pointLayer);

}


var pointLayer;
var renderer = OpenLayers.Util.getParameters(window.location.href).renderer;
renderer = (renderer) ? [renderer] : OpenLayers.Layer.Vector.prototype.renderers;
var pointLayerOSM = new OpenLayers.Layer.Vector('Points', {
        styleMap: new OpenLayers.StyleMap({
            pointRadius: "5", 
            fillColor: "#fc0000"
        }),
        renderers: renderer
    });

function addPointLayerOSM(){

  //window.mapOSM.removeLayer(pointLayerOSM);
  pointLayerOSM.destroyFeatures();
  if(typeof featureP != 'undefined'){
    console.log('borrando ' + featureP);
    pointLayerOSM.destroyFeatures();
  }
  var posOSM = [];
  var iconsOSM = [];
  var features = new Array(50);
      
  if(typeof dataList.lonlatValues.value != 'undefined'){
    
      posOSM = dataList.lonlatValues.value.split(',');

      var point = new OpenLayers.Geometry.Point(eval(posOSM[0]), eval(posOSM[1]));
      point.transform(fromProjection, toProjection);
      var featureP = new OpenLayers.Feature.Vector(point);

      pointLayerOSM.addFeatures([featureP]);
  }

  
  //mapOSM.addLayer(pointLayerOSM);
}

function removePoint(){
  window.map.removeLayer(pointLayer);
  pointLayerOSM.destroyFeatures();
}

var sourceViirs = new ol.source.WMTS({
    urls: [
        "https://map1a.vis.earthdata.nasa.gov/wmts-geo/wmts.cgi",
        "https://map1b.vis.earthdata.nasa.gov/wmts-geo/wmts.cgi",
        "https://map1c.vis.earthdata.nasa.gov/wmts-geo/wmts.cgi",
    ],
    layer: "VIIRS_CityLights_2012",
    format: "image/jpeg",
    matrixSet: "EPSG4326_500m",
    tileGrid: new ol.tilegrid.WMTS({
        origin: [-180, 90],
        resolutions: [
            0.5625,
            0.28125,
            0.140625,
            0.0703125,
            0.03515625,
            0.017578125,
            0.0087890625,
            0.00439453125,
            0.002197265625
        ],
        matrixIds: [0, 1, 2, 3, 4, 5, 6, 7, 8],
        tileSize: 512
    }),
    attributions: [
        new ol.Attribution({html:"NASA NPP - VIIRS"})
    ]
});

var viirs = new ol.layer.Tile({source: sourceViirs});


// auxiliar functions



function removeOptions(){

    var xyDeleted = false;

    window.map.removeLayer(pointLayer);
    if (pointLayerOSM.features.count > 0){ window.mapOSM.removeLayer(pointLayerOSM); }
    dataList.xyValues.value = '';
    dataList.lonlatValues.value = '';
    xyDeleted = true;
    addPointLayer();
    addPointLayerOSM();
}

function removeAllOptions(){

    removePoint();
    $('input[name=sharp]').attr('checked',false);
    $('input[name=cloud]').attr('checked',false);
    dataList.xyValues.value = '';
    dataList.lonlatValues.value = '';
}

function readSharp(){
  var sharp = document.imageQuality.sharp;
  var retornar = "";
  var i;
  for (i=0;i<sharp.length;i++) {
    if (sharp[i].checked) {
        retornar = sharp[i].value;
    }
  }
  return retornar
}

function readCloud(){
  var cloud = document.imageQuality.cloud;
  var retornar = "";
  var i;
  for (i=0;i<cloud.length;i++) {
    if (cloud[i].checked) {
        retornar = cloud[i].value;
    }
  }
  return retornar
}

function verifyPoints(){
  var countXY = 0;
  if (document.dataList.xyValues.value.length > 0) { countXY = 1; }
  var countLONLAT = 0;
  if (document.dataList.lonlatValues.value.length > 0) { countLONLAT = 1; }
  var devolver = true;
  if (countXY != countLONLAT){
    alert(i18n_alertMessage(1));
    devolver = false;
  } else if (countXY == 0){
    alert(i18n_alertMessage(2));
  devolver = false;
  }
  return devolver;
}

pybossa.run('LostAtNight');
</script>

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-1910419-4', 'citiesatnight.org');
  ga('require', 'displayfeatures');
  ga('send', 'pageview');

</script>


<script>
// Default language
var userLocale = "en";
// Translations
var messages = {"en": {
                        "i18n_welldone": "Well done!",
                        "i18n_welldone_text": "Your answer has been saved",
                        "i18n_loading_next_task": "Loading next task...",
                        "i18n_task_completed": "The task has been completed! Thanks a lot!",
                        "i18n_congratulations": "Congratulations",
                        "i18n_congratulations_text": "You have participated in all available tasks!",
                        "i18n_no_photo": "No photo",
                        "i18n_i_dont_know": "I don't know",
                        "i18n_working_task": "You are working now on task:",
                        "i18n_tasks_completed": "You have completed: ",
                        "i18n_tasks_from": " tasks from ",
                        "i18n_quiestion":"Do you know about this City?",
                        "i18n_save":"Save",
                        "i18n_wait":"Please, be patient with large ISS images",
                        "i18n_imagesharp":"Image Sharpness:",
                        "i18n_good":"Good",
                        "i18n_medium":"Medium",
                        "i18n_poor":"Poor",
                        "i18n_cloudy":"Cloudy",
                        "i18n_none":"None",
                        "i18n_few":"Less than 50%",
                        "i18n_more":"More than 50%",
                        "i18n_zoom":"Green point indicates ISS location at picture time. Use the [+] and [-] buttons to Zoom In and Zoom Out. Keep Shift + Left mouse button pressed while moving the mouse will rotate the image.",
                        "i18n_doNotGuess":"Please do not just guess at a location; that wastes time when verifying results. Please only place a mark if you are absolutely sure that its location is accurate and can be later geo-referenced point-by-point, else press the I-Don't-Know button.",
                        "i18n_viirs":"2012 Night View from SNPP-VIIRS"
                     },
                      "es": {
                        "i18n_welldone": "Bien hecho!",
                        "i18n_welldone_text": "Tu respuesta ha sido guardada",
                        "i18n_loading_next_task": "Cargando la siguiente tarea...",
                        "i18n_task_completed": "La tarea ha sido completadas! Muchísimas gracias",
                        "i18n_congratulations": "Enhorabuena",
                        "i18n_congratulations_text": "Has participado en todas las tareas disponibles!",
                        "i18n_no_photo": "No hay foto",
                        "i18n_i_dont_know": "No lo sé",
                        "i18n_working_task": "Estas trabajando en la tarea:",
                        "i18n_tasks_completed": "Has completado: ",
                        "i18n_tasks_from": " tareas de ",
                        "i18n_quiestion":"Intenta localizar esta ciudad",
                        "i18n_save":"Guardar",
                        "i18n_wait":"Por favor, espera un poco las imagenes de la ISS son grandes",
                        "i18n_imagesharp":"Enfoque:",
                        "i18n_good":"Bueno",
                        "i18n_medium":"Medio",
                        "i18n_poor":"Pobre",
                        "i18n_cloudy":"Nubosidad",
                        "i18n_none":"Ninguna",
                        "i18n_few":"Menos de 50%",
                        "i18n_more":"Más de 50%",
                        "i18n_zoom":"Punto verde indica la ubicación de la ISS en el momento de la foto. Usa  [+] y [-] para agrandar y empequeñecer. Presiona Mayúsculas + botón izquierdo del ratón mientras mueves el ratón para rotar la imagen.",
                        "i18n_doNotGuess":"Por favor, no acaba de adivinar en un lugar; que hace perder tiempo al verificar los resultados. Por favor solo colocar una marca si está absolutamente seguro de que su ubicación es exacta y puede ser posterior georreferenciada punto por punto; o bien presione el botón No-Lo-Sé.",
                        "i18n_viirs":"Imagen nocturna de SNPP-VIIRS (2012)"
                     },      
};
var alertMessages = {"en":  {
                              1: "Both an XY point and a LONLAT must be present",
                              2: "Please enter both an XY point and a LONLAT"
                            },
                      "es": {
                              1: "Tanto el punto XY y una LONLAT debe estar presente",
                              2: "Por favor, ingrese la vez un punto XY y una LONLAT"
                            },
};
// Update userLocale with server side information
$(document).ready(function(){
    userLocale = document.getElementById('PYBOSSA_USER_LOCALE').textContent.trim();
    i18n_translate();
});

function i18n_translate() {
    var ids = Object.keys(messages[userLocale])
    for (i=0; i<ids.length; i++) {
        console.log("Translating: " + ids[i]);
        document.getElementById(ids[i]).innerHTML = messages[userLocale][ids[i]];
    }
}

function i18n_alertMessage(msgNumber) {
  return alertMessages[userLocale][msgNumber];
}
</script>
